{"ast":null,"code":"import _asyncToGenerator from \"@babel/runtime/helpers/asyncToGenerator\";\nimport Constants from 'expo-constants';\nimport { CodedError, Platform, SyntheticPlatformEmitter } from 'expo-modules-core';\nexport default function getDevicePushTokenAsync() {\n  return _getDevicePushTokenAsync.apply(this, arguments);\n}\n\nfunction _getDevicePushTokenAsync() {\n  _getDevicePushTokenAsync = _asyncToGenerator(function* () {\n    var data = yield _subscribeDeviceToPushNotificationsAsync();\n    SyntheticPlatformEmitter.emit('onDevicePushToken', {\n      devicePushToken: data\n    });\n    return {\n      type: Platform.OS,\n      data: data\n    };\n  });\n  return _getDevicePushTokenAsync.apply(this, arguments);\n}\n\nfunction guardPermission() {\n  if (!('Notification' in window)) {\n    throw new CodedError('ERR_UNAVAILABLE', 'The Web Notifications API is not available on this device.');\n  }\n\n  if (!navigator.serviceWorker) {\n    throw new CodedError('ERR_UNAVAILABLE', 'Notifications cannot be used because the service worker API is not supported on this device. This might also happen because your web page does not support HTTPS.');\n  }\n\n  if (Notification.permission !== 'granted') {\n    throw new CodedError('ERR_NOTIFICATIONS_PERMISSION_DENIED', \"Cannot use web notifications without permissions granted. Request permissions with \\\"expo-permissions\\\".\");\n  }\n}\n\nfunction _subscribeDeviceToPushNotificationsAsync() {\n  return _subscribeDeviceToPushNotificationsAsync2.apply(this, arguments);\n}\n\nfunction _subscribeDeviceToPushNotificationsAsync2() {\n  _subscribeDeviceToPushNotificationsAsync2 = _asyncToGenerator(function* () {\n    var _Constants$expoConfig, _Constants$expoConfig2, _Constants$expoConfig3, _Constants$expoConfig4, _Constants$expoConfig5, _Constants$expoConfig6;\n\n    var vapidPublicKey = (_Constants$expoConfig = Constants.expoConfig) == null ? void 0 : (_Constants$expoConfig2 = _Constants$expoConfig.notification) == null ? void 0 : _Constants$expoConfig2.vapidPublicKey;\n\n    if (!vapidPublicKey) {\n      throw new CodedError('ERR_NOTIFICATIONS_PUSH_WEB_MISSING_CONFIG', 'You must provide `notification.vapidPublicKey` in `app.json` to use push notifications on web. Learn more: https://docs.expo.dev/versions/latest/guides/using-vapid/.');\n    }\n\n    var serviceWorkerPath = (_Constants$expoConfig3 = Constants.expoConfig) == null ? void 0 : (_Constants$expoConfig4 = _Constants$expoConfig3.notification) == null ? void 0 : _Constants$expoConfig4.serviceWorkerPath;\n\n    if (!serviceWorkerPath) {\n      throw new CodedError('ERR_NOTIFICATIONS_PUSH_MISSING_CONFIGURATION', 'You must specify `notification.serviceWorkerPath` in `app.json` to use push notifications on the web. Please provide the path to the service worker that will handle notifications.');\n    }\n\n    guardPermission();\n    var registration = null;\n\n    try {\n      registration = yield navigator.serviceWorker.register(serviceWorkerPath);\n    } catch (error) {\n      throw new CodedError('ERR_NOTIFICATIONS_PUSH_REGISTRATION_FAILED', \"Could not register this device for push notifications because the service worker (\" + serviceWorkerPath + \") could not be registered: \" + error);\n    }\n\n    yield navigator.serviceWorker.ready;\n\n    if (!registration.active) {\n      throw new CodedError('ERR_NOTIFICATIONS_PUSH_REGISTRATION_FAILED', 'Could not register this device for push notifications because the service worker is not active.');\n    }\n\n    var subscribeOptions = {\n      userVisibleOnly: true,\n      applicationServerKey: _urlBase64ToUint8Array(vapidPublicKey)\n    };\n    var pushSubscription = null;\n\n    try {\n      pushSubscription = yield registration.pushManager.subscribe(subscribeOptions);\n    } catch (error) {\n      throw new CodedError('ERR_NOTIFICATIONS_PUSH_REGISTRATION_FAILED', 'The device was unable to register for remote notifications with the browser endpoint. (' + error + ')');\n    }\n\n    var pushSubscriptionJson = pushSubscription.toJSON();\n    var subscriptionObject = {\n      endpoint: pushSubscriptionJson.endpoint,\n      keys: {\n        p256dh: pushSubscriptionJson.keys.p256dh,\n        auth: pushSubscriptionJson.keys.auth\n      }\n    };\n    var notificationIcon = ((_Constants$expoConfig5 = (_Constants$expoConfig6 = Constants.expoConfig) == null ? void 0 : _Constants$expoConfig6.notification) != null ? _Constants$expoConfig5 : {}).icon;\n    yield registration.active.postMessage(JSON.stringify({\n      fromExpoWebClient: {\n        notificationIcon: notificationIcon\n      }\n    }));\n    return subscriptionObject;\n  });\n  return _subscribeDeviceToPushNotificationsAsync2.apply(this, arguments);\n}\n\nfunction _urlBase64ToUint8Array(base64String) {\n  var padding = '='.repeat((4 - base64String.length % 4) % 4);\n  var base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');\n  var rawData = window.atob(base64);\n  var outputArray = new Uint8Array(rawData.length);\n\n  for (var i = 0; i < rawData.length; ++i) {\n    outputArray[i] = rawData.charCodeAt(i);\n  }\n\n  return outputArray;\n}","map":{"version":3,"mappings":"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","names":["Constants","CodedError","Platform","SyntheticPlatformEmitter","getDevicePushTokenAsync","data","_subscribeDeviceToPushNotificationsAsync","emit","devicePushToken","type","OS","guardPermission","window","navigator","serviceWorker","Notification","permission","vapidPublicKey","expoConfig","notification","serviceWorkerPath","registration","register","error","ready","active","subscribeOptions","userVisibleOnly","applicationServerKey","_urlBase64ToUint8Array","pushSubscription","pushManager","subscribe","pushSubscriptionJson","toJSON","subscriptionObject","endpoint","keys","p256dh","auth","notificationIcon","icon","postMessage","JSON","stringify","fromExpoWebClient","base64String","padding","repeat","length","base64","replace","rawData","atob","outputArray","Uint8Array","i","charCodeAt"],"sourceRoot":"","sources":["../src/getDevicePushTokenAsync.web.ts"],"sourcesContent":["import Constants from 'expo-constants';\nimport { CodedError, Platform, SyntheticPlatformEmitter } from 'expo-modules-core';\n\nimport { DevicePushToken } from './Tokens.types';\n\nexport default async function getDevicePushTokenAsync(): Promise<DevicePushToken> {\n  const data = await _subscribeDeviceToPushNotificationsAsync();\n  SyntheticPlatformEmitter.emit('onDevicePushToken', { devicePushToken: data });\n  return { type: Platform.OS, data };\n}\n\nfunction guardPermission() {\n  if (!('Notification' in window)) {\n    throw new CodedError(\n      'ERR_UNAVAILABLE',\n      'The Web Notifications API is not available on this device.'\n    );\n  }\n  if (!navigator.serviceWorker) {\n    throw new CodedError(\n      'ERR_UNAVAILABLE',\n      'Notifications cannot be used because the service worker API is not supported on this device. This might also happen because your web page does not support HTTPS.'\n    );\n  }\n  if (Notification.permission !== 'granted') {\n    throw new CodedError(\n      'ERR_NOTIFICATIONS_PERMISSION_DENIED',\n      `Cannot use web notifications without permissions granted. Request permissions with \"expo-permissions\".`\n    );\n  }\n}\n\nasync function _subscribeDeviceToPushNotificationsAsync(): Promise<DevicePushToken['data']> {\n  // @ts-expect-error: TODO: not on the schema\n  const vapidPublicKey: string | null = Constants.expoConfig?.notification?.vapidPublicKey;\n  if (!vapidPublicKey) {\n    throw new CodedError(\n      'ERR_NOTIFICATIONS_PUSH_WEB_MISSING_CONFIG',\n      'You must provide `notification.vapidPublicKey` in `app.json` to use push notifications on web. Learn more: https://docs.expo.dev/versions/latest/guides/using-vapid/.'\n    );\n  }\n\n  // @ts-expect-error: TODO: not on the schema\n  const serviceWorkerPath = Constants.expoConfig?.notification?.serviceWorkerPath;\n  if (!serviceWorkerPath) {\n    throw new CodedError(\n      'ERR_NOTIFICATIONS_PUSH_MISSING_CONFIGURATION',\n      'You must specify `notification.serviceWorkerPath` in `app.json` to use push notifications on the web. Please provide the path to the service worker that will handle notifications.'\n    );\n  }\n  guardPermission();\n\n  let registration: ServiceWorkerRegistration | null = null;\n  try {\n    registration = await navigator.serviceWorker.register(serviceWorkerPath);\n  } catch (error) {\n    throw new CodedError(\n      'ERR_NOTIFICATIONS_PUSH_REGISTRATION_FAILED',\n      `Could not register this device for push notifications because the service worker (${serviceWorkerPath}) could not be registered: ${error}`\n    );\n  }\n  await navigator.serviceWorker.ready;\n\n  if (!registration.active) {\n    throw new CodedError(\n      'ERR_NOTIFICATIONS_PUSH_REGISTRATION_FAILED',\n      'Could not register this device for push notifications because the service worker is not active.'\n    );\n  }\n\n  const subscribeOptions = {\n    userVisibleOnly: true,\n    applicationServerKey: _urlBase64ToUint8Array(vapidPublicKey),\n  };\n  let pushSubscription: PushSubscription | null = null;\n  try {\n    pushSubscription = await registration.pushManager.subscribe(subscribeOptions);\n  } catch (error) {\n    throw new CodedError(\n      'ERR_NOTIFICATIONS_PUSH_REGISTRATION_FAILED',\n      'The device was unable to register for remote notifications with the browser endpoint. (' +\n        error +\n        ')'\n    );\n  }\n  const pushSubscriptionJson = pushSubscription.toJSON();\n\n  const subscriptionObject = {\n    endpoint: pushSubscriptionJson.endpoint,\n    keys: {\n      p256dh: pushSubscriptionJson.keys!.p256dh,\n      auth: pushSubscriptionJson.keys!.auth,\n    },\n  };\n\n  // Store notification icon string in service worker.\n  // This message is received by `/expo-service-worker.js`.\n  // We wrap it with `fromExpoWebClient` to make sure other message\n  // will not override content such as `notificationIcon`.\n  // https://stackoverflow.com/a/35729334/2603230\n  const notificationIcon = (Constants.expoConfig?.notification ?? {}).icon;\n  await registration.active.postMessage(\n    JSON.stringify({ fromExpoWebClient: { notificationIcon } })\n  );\n\n  return subscriptionObject;\n}\n\n// https://github.com/web-push-libs/web-push#using-vapid-key-for-applicationserverkey\nfunction _urlBase64ToUint8Array(base64String: string): Uint8Array {\n  const padding = '='.repeat((4 - (base64String.length % 4)) % 4);\n  const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');\n\n  const rawData = window.atob(base64);\n  const outputArray = new Uint8Array(rawData.length);\n\n  for (let i = 0; i < rawData.length; ++i) {\n    outputArray[i] = rawData.charCodeAt(i);\n  }\n  return outputArray;\n}\n"]},"metadata":{},"sourceType":"module"}